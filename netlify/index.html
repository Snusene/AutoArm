<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoArm Weapon Balance Analyzer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
            background-image: url('https://i.redd.it/0406lf9xw68f1.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            backdrop-filter: blur(5px);
        }

        h1 {
            color: #333;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.8);
        }

        .controls {
            margin-bottom: 30px;
            padding: 15px;
            background-color: rgba(232, 244, 253, 0.95);
            border-radius: 5px;
        }

        .control-row {
            display: flex;
            gap: 30px;
            align-items: center;
            margin-bottom: 15px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        label {
            font-weight: bold;
        }

        input[type="number"] {
            width: 80px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        input[type="checkbox"] {
            margin-right: 5px;
            cursor: pointer;
        }

        select {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .note {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
            padding: 10px;
            background-color: rgba(249, 249, 249, 0.95);
            border-left: 3px solid #2196F3;
        }

        .search-container {
            position: relative;
            display: inline-block;
        }

        #weaponSearch {
            width: 220px;
            padding: 5px 25px 5px 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .clear-search {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #999;
            display: none;
            font-size: 16px;
            padding: 0 5px;
        }

            .clear-search:hover {
                color: #333;
            }

        .no-results {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }

        .highlight {
            background-color: rgba(255, 235, 59, 0.5);
            font-weight: bold;
        }

        .mod-link {
            color: #1976d2;
            text-decoration: none;
            font-weight: bold;
        }

            .mod-link:hover {
                text-decoration: underline;
                color: #1565c0;
            }

            .mod-link .highlight {
                background-color: rgba(255, 235, 59, 0.7);
            }

        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .weapon-section {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            height: 600px; /* Fixed height for the section */
        }

            .weapon-section h2 {
                margin-top: 0;
                color: #555;
                flex-shrink: 0; /* Keep header fixed */
            }

        .table-container {
            flex: 1;
            overflow-y: auto;
            margin-top: 10px;
            border: 1px solid #eee;
            border-radius: 3px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: rgba(255, 255, 255, 0.8);
        }

        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        tbody tr:nth-child(even) {
            background-color: rgba(250, 250, 250, 0.5);
        }

        tbody tr:hover {
            background-color: rgba(240, 240, 240, 0.8);
        }

        th {
            background-color: rgba(248, 248, 248, 0.95);
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
        }

        .score {
            font-weight: bold;
            color: #0066cc;
        }

        .ap-value {
            color: #8b4513;
            font-weight: 600;
        }

        .mod-tag {
            font-size: 0.8em;
            color: #666;
            font-style: italic;
        }

        .modded-weapon {
            background-color: rgba(245, 245, 255, 0.7);
        }

            .modded-weapon .mod-link {
                color: #1565c0;
            }

                .modded-weapon .mod-link:hover {
                    color: #0d47a1;
                }

        .skill-score {
            font-weight: 600;
        }

        .recommendation {
            margin-top: 30px;
            padding: 20px;
            background-color: rgba(255, 248, 220, 0.95);
            border-radius: 5px;
            border: 1px solid #daa520;
        }

            .recommendation h3 {
                margin-top: 0;
                color: #b8860b;
            }

        .quality-info {
            background-color: rgba(227, 242, 253, 0.95);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

            .quality-info h4 {
                margin-top: 0;
                color: #1976d2;
            }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #666;
        }

        .error {
            background-color: #fee;
            border: 1px solid #fcc;
            padding: 15px;
            border-radius: 5px;
            color: #c00;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AutoArm</h1>

        <div id="loadingMessage" class="loading">Loading weapon data...</div>
        <div id="errorMessage" class="error" style="display: none;"></div>

        <div id="mainContent" style="display: none;">
            <div class="quality-info">
                <h4>AutoArm Weapon Scoring System</h4>
                <p>This interactive tool lets you visualize and adjust how AutoArm evaluates weapons. <strong>The higher the score, the more likely a colonist is to upgrade to that weapon.</strong> Scores are based on:</p>
                <ul>
                    <li><strong>DPS (Damage Per Second):</strong> Core weapon effectiveness</li>
                    <li><strong>Range:</strong> Kiting potential and tactical flexibility</li>
                    <li><strong>Burst Fire:</strong> Multiple shots with diminishing returns</li>
                    <li><strong>Armor Penetration:</strong> Effectiveness against late-game threats</li>
                    <li><strong>Skill Preferences:</strong> Colonist shooting vs melee skills</li>
                </ul>
                <p style="font-style: italic; color: #555; margin-top: 10px; font-weight: 500;">Developer note: This is the actual tool I use when fine-tuning AutoArm's weapon scoring balance. <span style="color: #1976d2;">Click any [MOD] tag to visit its Steam Workshop page!</span></p>
                <div class="note" style="margin-top: 15px; background-color: rgba(255, 255, 255, 0.95);">
                    <p><strong>About this system:</strong> Since vanilla RimWorld lacks automatic weapon equipping and therefore has no weapon evaluation formula to reference, AutoArm creates its own scoring system from scratch. No formula is perfect for every playstyle, but this aims to work well for most situations while also trying to respect modded behaviors (e.g., "Hunters Use Melee" mods).</p>
                    <p><strong>Override options:</strong> Force-equip weapons (right-click) to prevent replacement, or use outfit filters to restrict weapon types per colonist.</p>
                </div>
                <details style="margin-top: 10px; background-color: rgba(255, 255, 255, 0.9); padding: 10px; border-radius: 5px;">
                    <summary style="cursor: pointer; font-weight: bold;">Skill Bonus Progression Table</summary>
                    <table style="margin-top: 10px; font-size: 0.9em;">
                        <tr><th>Skill Diff</th><th>Bonus</th><th>Penalty</th></tr>
                        <tr><td>1</td><td>+30</td><td>-15</td></tr>
                        <tr><td>2</td><td>+35</td><td>-17</td></tr>
                        <tr><td>3</td><td>+40</td><td>-20</td></tr>
                        <tr><td>5</td><td>+52</td><td>-26</td></tr>
                        <tr><td>10</td><td>+117</td><td>-59</td></tr>
                        <tr><td>15</td><td>+244</td><td>-122</td></tr>
                        <tr><td>20</td><td>+490</td><td>-245</td></tr>
                    </table>
                    <p style="margin-top: 10px; font-size: 0.9em;">
                        <strong>Trait Modifiers:</strong><br>
                        • Brawler trait: +200 melee, -500 ranged<br>
                        • Hunting work: Ranged bonuses only<br>
                        &nbsp;&nbsp;- 30+ range: +300<br>
                        &nbsp;&nbsp;- 20-29 range: +200<br>
                        &nbsp;&nbsp;- Under 20 range: +100
                    </p>
                </details>
            </div>

            <div class="controls">
                <h3>Scoring Configuration</h3>
                <div class="control-row">
                    <div class="control-group">
                        <label>Quality Level:</label>
                        <select id="qualityLevel" onchange="updateScores()">
                            <option value="0.5">Awful (50%)</option>
                            <option value="0.8">Poor (80%)</option>
                            <option value="1.0" selected>Normal (100%)</option>
                            <option value="1.15">Good (115%)</option>
                            <option value="1.3">Excellent (130%)</option>
                            <option value="1.45">Masterwork (145%)</option>
                            <option value="1.6">Legendary (160%)</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Show Weapons:</label>
                        <select id="weaponFilter" onchange="filterWeapons(); updateScores()">
                            <option value="vanilla" selected>Vanilla Only</option>
                            <option value="all">Vanilla + Modded</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Search:</label>
                        <div class="search-container">
                            <input type="text" id="weaponSearch" placeholder="e.g. rifle, [VWE], sword..." oninput="handleSearchInput()">
                            <span class="clear-search" onclick="clearSearch()">×</span>
                        </div>
                    </div>
                </div>
                <div class="control-row">
                    <div class="control-group">
                        <label>Shooting Skill:</label>
                        <input type="range" id="shootingSkill" min="0" max="20" value="10" oninput="updateSkillDisplay(this, 'shootingDisplay'); updateScores()">
                        <span id="shootingDisplay" style="width: 30px; display: inline-block;">10</span>
                    </div>
                    <div class="control-group">
                        <label>Melee Skill:</label>
                        <input type="range" id="meleeSkill" min="0" max="20" value="10" oninput="updateSkillDisplay(this, 'meleeDisplay'); updateScores()">
                        <span id="meleeDisplay" style="width: 30px; display: inline-block;">10</span>
                    </div>
                    <div class="control-group">
                        <label><input type="checkbox" id="brawlerTrait" onchange="updateScores()"> Brawler</label>
                    </div>
                    <div class="control-group">
                        <label><input type="checkbox" id="hunterRole" onchange="updateScores()"> Hunting Work</label>
                    </div>
                </div>
                <div class="note" style="background-color: rgba(255, 255, 255, 0.95);">
                    <strong>How to use:</strong> Adjust quality level and skill sliders to see how they affect weapon scoring. Higher skill differences create stronger preferences. Check Brawler for colonists with that trait (massive ranged penalty), or Hunting Work for colonists who get bonuses for ranged weapons. Mod tags like [VWE] and [RS] are clickable links to their Steam Workshop pages.
                </div>
            </div>

            <div class="comparison">
                <div class="weapon-section">
                    <h2>Ranged Weapons <span id="rangedCount" style="font-size: 0.8em; color: #666;"></span></h2>
                    <div class="table-container">
                        <table id="rangedTable">
                            <thead>
                                <tr>
                                    <th>Weapon</th>
                                    <th>DPS (w/Q)</th>
                                    <th>Burst</th>
                                    <th>Range</th>
                                    <th>AP</th>
                                    <th>Base Score</th>
                                    <th>Skill Score</th>
                                    <th>Total Score</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="weapon-section">
                    <h2>Melee Weapons <span id="meleeCount" style="font-size: 0.8em; color: #666;"></span></h2>
                    <div class="table-container">
                        <table id="meleeTable">
                            <thead>
                                <tr>
                                    <th>Weapon</th>
                                    <th>DPS (w/Q)</th>
                                    <th>AP</th>
                                    <th>Base Score</th>
                                    <th>Skill Score</th>
                                    <th>Total Score</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="recommendation" id="recommendation"></div>
        </div>
    </div>

    <!-- Load the external weapon data file -->
    <script src="weapons-data.js" onerror="handleWeaponDataError()"></script>

    <script>
        // Initialize weapon arrays
        let vanillaRangedWeapons = [];
        let vanillaMeleeWeapons = [];
        let moddedRangedWeapons = [];
        let moddedMeleeWeapons = [];
        let rangedWeapons = [];
        let meleeWeapons = [];

        // Handle loading error
        function handleWeaponDataError() {
            console.error('Failed to load weapons-data.js');
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorMessage').innerHTML =
                '<strong>Error:</strong> Failed to load weapons-data.js<br>' +
                'Please make sure:<br>' +
                '1. weapons-data.js is in the same folder as index.html<br>' +
                '2. The file name is exactly "weapons-data.js" (case sensitive)<br>' +
                '3. If running locally, use a web server (not file://)';
        }

        // Function to initialize the application
        function initializeApp() {
            console.log('Attempting to initialize app...');
            console.log('window.weaponData exists?', !!window.weaponData);

            try {
                if (window.weaponData) {
                    console.log('Loading weapon data...');

                    // Load weapon data from external file
                    vanillaRangedWeapons = window.weaponData.vanillaRangedWeapons || [];
                    vanillaMeleeWeapons = window.weaponData.vanillaMeleeWeapons || [];
                    moddedRangedWeapons = window.weaponData.moddedRangedWeapons || [];
                    moddedMeleeWeapons = window.weaponData.moddedMeleeWeapons || [];

                    console.log('Loaded weapons:', {
                        vanillaRanged: vanillaRangedWeapons.length,
                        vanillaMelee: vanillaMeleeWeapons.length,
                        moddedRanged: moddedRangedWeapons.length,
                        moddedMelee: moddedMeleeWeapons.length
                    });

                    // Initialize with vanilla weapons
                    filterWeapons();

                    // Hide loading message and show main content
                    document.getElementById('loadingMessage').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';

                    // Initial update
                    updateScores();

                    console.log('Application initialized successfully!');
                } else {
                    throw new Error('window.weaponData is undefined');
                }
            } catch (error) {
                console.error('Error during initialization:', error);
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').innerHTML =
                    '<strong>Error:</strong> ' + error.message + '<br>' +
                    'Check the browser console (F12) for more details.';
            }
        }

        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function () {
                // Give the weapons-data.js script a moment to execute
                setTimeout(initializeApp, 100);
            });
        } else {
            // DOM is already ready, wait a moment for weapons-data.js
            setTimeout(initializeApp, 100);
        }

        // Workshop mod URLs mapping
        const modWorkshopUrls = {
            '[VWE]': 'https://steamcommunity.com/sharedfiles/filedetails/?id=1814383360', // Vanilla Weapons Expanded
            '[VWEQ]': 'https://steamcommunity.com/sharedfiles/filedetails/?id=1906780517', // VWE - Quickdraw
            '[VWEF]': 'https://steamcommunity.com/sharedfiles/filedetails/?id=2023513450', // VWE - Frontier
            '[VWEH]': 'https://steamcommunity.com/sharedfiles/filedetails/?id=2329126791', // VWE - Heavy Weapons
            '[VWEB]': 'https://steamcommunity.com/sharedfiles/filedetails/?id=2854967482', // VWE - Bioferrite (might be Anomaly weapons)
            '[VWEL]': 'https://steamcommunity.com/sharedfiles/filedetails/?id=1814987817', // VWE - Laser
            '[RS]': 'https://steamcommunity.com/sharedfiles/filedetails/?id=849231601', // Rimsenal - Core
            '[RSA]': 'https://steamcommunity.com/sharedfiles/filedetails/?id=849232906', // Rimsenal - Augmented
            '[CE]': 'https://steamcommunity.com/sharedfiles/filedetails/?id=2890901044', // Combat Extended
            '[W+]': 'https://steamcommunity.com/sharedfiles/filedetails/?id=1528163280', // Weapons+
            '[MT]': 'https://steamcommunity.com/sharedfiles/filedetails/?id=2007052872', // Medieval Times
            '[40K]': 'https://steamcommunity.com/workshop/browse/?appid=294100&searchtext=warhammer+40k+weapons', // Warhammer 40K (search)
            '[SW]': 'https://steamcommunity.com/workshop/browse/?appid=294100&searchtext=star+wars+weapons', // Star Wars (search)
            '[XCOM]': 'https://steamcommunity.com/workshop/browse/?appid=294100&searchtext=xcom+weapons', // XCOM (search)
            '[TF]': 'https://steamcommunity.com/workshop/browse/?appid=294100&searchtext=titanfall+weapons', // Titanfall (search)
            '[ME]': 'https://steamcommunity.com/workshop/browse/?appid=294100&searchtext=mass+effect+weapons', // Mass Effect (search)
            '[BB]': 'https://steamcommunity.com/workshop/browse/?appid=294100&searchtext=bloodborne+weapons', // Bloodborne (search)
            '[SK]': 'https://steamcommunity.com/workshop/browse/?appid=294100&searchtext=skyrim+weapons'  // Skyrim (search)
        };

        function processWeaponNameWithLinks(weaponName, searchText) {
            let processedName = weaponName;

            // First, add mod links
            const modTagRegex = /(\[[^\]]+\])/g;
            processedName = processedName.replace(modTagRegex, (match) => {
                const url = modWorkshopUrls[match];
                if (url) {
                    return `<a href="${url}" target="_blank" class="mod-link" title="View on Steam Workshop">${match}</a>`;
                }
                return match;
            });

            // Then highlight search terms (but not inside links)
            if (searchText) {
                const searchTerms = searchText.split(' ').filter(term => term.length > 0);
                searchTerms.forEach(term => {
                    // Escape special regex characters
                    const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    // Only highlight text that's not inside HTML tags
                    const regex = new RegExp(`(?![^<]*>)(${escapedTerm})`, 'gi');
                    processedName = processedName.replace(regex, '<span class="highlight">$1</span>');
                });
            }

            return processedName;
        }

        function updateSkillDisplay(slider, displayId) {
            document.getElementById(displayId).textContent = slider.value;
        }

        function handleSearchInput() {
            const searchBox = document.getElementById('weaponSearch');
            const clearButton = document.querySelector('.clear-search');

            if (searchBox.value.length > 0) {
                clearButton.style.display = 'block';
            } else {
                clearButton.style.display = 'none';
            }

            updateScores();
        }

        function clearSearch() {
            document.getElementById('weaponSearch').value = '';
            document.querySelector('.clear-search').style.display = 'none';
            updateScores();
        }

        function calculateArmorPenetrationScore(ap) {
            // Based on the C# implementation thresholds
            if (ap >= 0.75) // Can penetrate marine armor
                return 150;
            else if (ap >= 0.52) // Can penetrate flak vest
                return 100;
            else if (ap >= 0.40) // Can penetrate recon armor
                return 75;
            else if (ap >= 0.20) // Can penetrate basic armor
                return 50;
            else
                return ap * 100; // Linear scale for low AP
        }

        // Updated skill scoring with gradual exponential growth
        function calculateSkillScore(shootingSkill, meleeSkill, isRanged) {
            const skillDifference = Math.abs(shootingSkill - meleeSkill);
            const isBrawler = document.getElementById('brawlerTrait').checked;
            const isHunter = document.getElementById('hunterRole').checked;

            let baseScore = 0;

            if (skillDifference > 0) {
                // Start with base bonus of 30 for 1 level difference
                // Increase by 15% for each additional level (exponential growth)
                const baseBonus = 30;
                const growthRate = 1.15;
                const bonus = baseBonus * Math.pow(growthRate, skillDifference - 1);

                // Apply bonus or penalty based on weapon type
                if (isRanged) {
                    if (shootingSkill > meleeSkill) {
                        baseScore = bonus; // Positive bonus for matching skill
                    } else {
                        baseScore = -bonus * 0.5; // Half penalty for wrong type
                    }
                } else {
                    if (meleeSkill > shootingSkill) {
                        baseScore = bonus; // Positive bonus for matching skill
                    } else {
                        baseScore = -bonus * 0.5; // Half penalty for wrong type
                    }
                }
            }

            // Apply trait/role modifiers
            if (isBrawler) {
                if (isRanged) {
                    baseScore -= 500; // Brawler penalty for ranged weapons
                } else {
                    baseScore += 200; // Brawler bonus for melee weapons
                }
            }

            if (isHunter) {
                if (isRanged) {
                    // Base hunter bonus for any ranged weapon
                    baseScore += 100; // This gives the minimum +100 for all ranged
                }
                // No penalty for melee - hunters just prefer ranged
            }

            return baseScore;
        }

        function filterWeapons() {
            const filter = document.getElementById('weaponFilter').value;

            if (filter === 'vanilla') {
                rangedWeapons = [...vanillaRangedWeapons];
                meleeWeapons = [...vanillaMeleeWeapons];
            } else {
                rangedWeapons = [...vanillaRangedWeapons, ...moddedRangedWeapons];
                meleeWeapons = [...vanillaMeleeWeapons, ...moddedMeleeWeapons];
            }
        }

        function calculateRangedScore(weapon, multiplier, qualityMult, shootingSkill, meleeSkill) {
            // Apply situational weapon penalty
            if (weapon.situational) {
                // Situational weapons should score around 80 points regardless of their stats
                const baseScore = 80;
                const skillScore = calculateSkillScore(shootingSkill, meleeSkill, true);
                // Cap skill score impact for situational weapons
                const cappedSkillScore = Math.max(-20, Math.min(20, skillScore));
                return {
                    baseDPS: weapon.dps,
                    qualityDPS: weapon.dps * qualityMult,
                    ap: weapon.ap || 0,
                    baseTotal: baseScore,
                    skillScore: cappedSkillScore,
                    total: baseScore + cappedSkillScore
                };
            }

            // Apply quality to DPS (GetDamageAmount includes quality)
            let qualityDPS = weapon.dps * qualityMult;
            let baseScore = qualityDPS * multiplier;

            // Calculate AP (default formula: damage * 0.015)
            // If damage not specified, estimate from DPS
            let damage = weapon.damage || (weapon.dps * 2); // rough estimate if not specified
            let weaponAP = weapon.ap || (damage * 0.015);
            // Apply quality to AP
            weaponAP = weaponAP * qualityMult;

            // Apply range modifiers (from the code)
            if (weapon.range < 15) {
                baseScore *= 0.85;

                // Strong penalty for short-range high-burst weapons (can't kite effectively)
                if (weapon.burst > 3 && weapon.range < 18) {
                    baseScore *= 0.75; // Heavy SMG gets significant penalty
                }
            } else if (weapon.range >= 15 && weapon.range < 25) {
                baseScore *= 0.95;

                // Slight bonus for medium range burst weapons (good kiting ability)
                if (weapon.burst > 1 && weapon.range >= 20) {
                    baseScore *= 1.05; // Assault rifle gets small bonus
                }
            } else if (weapon.range >= 25 && weapon.range <= 35) {
                baseScore *= 1.0;
            } else if (weapon.range > 35) {
                baseScore *= 1.05;
            }

            // Range bonus (from the updated code)
            let rangeBonus = 0;
            if (weapon.range >= 30 && weapon.range <= 35) {
                rangeBonus = 70;  // Reduced from 100
            } else if (weapon.range >= 25 && weapon.range < 30) {
                rangeBonus = 55;  // Reduced from 80
            } else if (weapon.range >= 20 && weapon.range < 25) {
                rangeBonus = 40;  // Reduced from 60
            } else if (weapon.range >= 15 && weapon.range < 20) {
                rangeBonus = 25;  // Reduced from 40
            } else if (weapon.range >= 10 && weapon.range < 15) {
                rangeBonus = 15;  // Reduced from 25
            } else if (weapon.range < 10) {
                rangeBonus = 5;   // Reduced from 10
            } else if (weapon.range > 35 && weapon.range <= 45) {
                rangeBonus = 50;  // Reduced from 70
            }

            // Hunter bonus for long-range weapons
            const isHunter = document.getElementById('hunterRole').checked;
            let hunterBonus = 0;
            if (isHunter) {
                if (weapon.range >= 30) {
                    hunterBonus = 200; // +300 total (100 from skill score + 200 here)
                } else if (weapon.range >= 20) {
                    hunterBonus = 100; // +200 total (100 from skill score + 100 here)
                } else {
                    hunterBonus = 0; // +100 total (100 from skill score only)
                }
            }

            // Burst bonus with diminishing returns
            let burstBonus = 0;
            if (weapon.burst > 1) {
                // Diminishing returns: first extra shot worth 25, second worth 15, third+ worth 5 each
                if (weapon.burst >= 2) burstBonus += 25; // 2-shot gets +25
                if (weapon.burst >= 3) burstBonus += 15; // 3-shot gets +40 total
                if (weapon.burst >= 4) burstBonus += (weapon.burst - 3) * 5; // 4+ shots get +5 each

                baseScore += burstBonus;

                // Range-based burst penalty - short range burst weapons can't kite effectively
                if (weapon.range < 20) {
                    // The shorter the range, the worse burst weapons perform (can't kite)
                    const rangePenalty = (20 - weapon.range) / 20; // 0-1 scale
                    const burstPenalty = (weapon.burst - 1) * 10 * rangePenalty;
                    baseScore -= burstPenalty;

                    // Extra penalty for very high burst at very short range
                    if (weapon.burst >= 5 && weapon.range < 17) {
                        baseScore -= 20; // Heavy SMG specific penalty
                    }
                }
            }

            let apScore = calculateArmorPenetrationScore(weaponAP);
            let skillScore = calculateSkillScore(shootingSkill, meleeSkill, true); // true for ranged

            // Base total includes damage, range, AP, and hunter bonus
            let baseTotal = baseScore + rangeBonus + apScore + hunterBonus;

            return {
                baseDPS: weapon.dps,
                qualityDPS: qualityDPS,
                ap: weaponAP,
                baseTotal: baseTotal,
                skillScore: skillScore,
                total: baseTotal + skillScore
            };
        }

        function calculateMeleeScore(weapon, multiplier, qualityMult, shootingSkill, meleeSkill) {
            // MeleeWeapon_AverageDPS with quality included
            let qualityDPS = weapon.dps * qualityMult;
            let baseScore = qualityDPS * multiplier;

            // Apply quality to AP
            let weaponAP = weapon.ap * qualityMult;
            let apScore = calculateArmorPenetrationScore(weaponAP);
            let skillScore = calculateSkillScore(shootingSkill, meleeSkill, false); // false for melee

            // Base total includes DPS and AP
            let baseTotal = baseScore + apScore;

            return {
                baseDPS: weapon.dps,
                qualityDPS: qualityDPS,
                ap: weaponAP,
                baseTotal: baseTotal,
                skillScore: skillScore,
                total: baseTotal + skillScore
            };
        }

        function updateScores() {
            const rangedMult = 8; // Fixed multiplier for ranged weapons
            const meleeMult = 10; // Fixed multiplier for melee weapons
            const qualityMult = parseFloat(document.getElementById('qualityLevel').value);
            const shootingSkill = parseInt(document.getElementById('shootingSkill').value);
            const meleeSkill = parseInt(document.getElementById('meleeSkill').value);
            const searchText = document.getElementById('weaponSearch').value.toLowerCase();

            // Update ranged weapons table
            const rangedTbody = document.querySelector('#rangedTable tbody');
            rangedTbody.innerHTML = '';

            let totalRangedScore = 0;
            let rangedCount = 0;

            // Filter weapons based on search text
            const filteredRangedWeapons = rangedWeapons.filter(weapon => {
                const searchableText = weapon.name.toLowerCase();
                const searchTerms = searchText.split(' ').filter(term => term.length > 0);

                // If no search terms, show all
                if (searchTerms.length === 0) return true;

                // Check if all search terms are found in the weapon name
                return searchTerms.every(term => searchableText.includes(term));
            });

            // Calculate scores for all weapons first
            const rangedScores = filteredRangedWeapons.map(weapon => {
                const scores = calculateRangedScore(weapon, rangedMult, qualityMult, shootingSkill, meleeSkill);
                totalRangedScore += scores.total;
                rangedCount++;
                return { weapon, scores };
            });

            // Sort by total score (highest first)
            rangedScores.sort((a, b) => b.scores.total - a.scores.total);

            // Add sorted rows to table
            if (rangedScores.length === 0) {
                const row = rangedTbody.insertRow();
                row.innerHTML = '<td colspan="8" class="no-results">No weapons match your search</td>';
            } else {
                rangedScores.forEach(({ weapon, scores }) => {
                    const row = rangedTbody.insertRow();
                    const skillScoreClass = scores.skillScore > 0 ? 'style="color: green;"' : scores.skillScore < 0 ? 'style="color: red;"' : '';
                    const burstText = weapon.burst > 1 ? `${weapon.burst}x` : '-';
                    const rowClass = weapon.mod ? 'modded-weapon' : '';
                    const weaponName = weapon.mod ? weapon.name : weapon.name;
                    const processedName = processWeaponNameWithLinks(weaponName, searchText);

                    row.className = rowClass;
                    row.innerHTML = `
                                            <td>${processedName}</td>
                                            <td>${scores.qualityDPS.toFixed(1)}</td>
                                            <td>${burstText}</td>
                                            <td>${weapon.range}</td>
                                            <td class="ap-value">${scores.ap.toFixed(3)}</td>
                                            <td>${scores.baseTotal.toFixed(1)}</td>
                                            <td ${skillScoreClass}>${scores.skillScore > 0 ? '+' : ''}${scores.skillScore !== 0 ? scores.skillScore.toFixed(0) : '0'}</td>
                                            <td class="score">${scores.total.toFixed(1)}</td>
                                        `;
                });
            }

            // Update melee weapons table
            const meleeTbody = document.querySelector('#meleeTable tbody');
            meleeTbody.innerHTML = '';

            let totalMeleeScore = 0;
            let meleeCount = 0;

            // Filter weapons based on search text
            const filteredMeleeWeapons = meleeWeapons.filter(weapon => {
                const searchableText = weapon.name.toLowerCase();
                const searchTerms = searchText.split(' ').filter(term => term.length > 0);

                // If no search terms, show all
                if (searchTerms.length === 0) return true;

                // Check if all search terms are found in the weapon name
                return searchTerms.every(term => searchableText.includes(term));
            });

            // Calculate scores for all weapons first
            const meleeScores = filteredMeleeWeapons.map(weapon => {
                const scores = calculateMeleeScore(weapon, meleeMult, qualityMult, shootingSkill, meleeSkill);
                totalMeleeScore += scores.total;
                meleeCount++;
                return { weapon, scores };
            });

            // Sort by total score (highest first)
            meleeScores.sort((a, b) => b.scores.total - a.scores.total);

            // Add sorted rows to table
            if (meleeScores.length === 0) {
                const row = meleeTbody.insertRow();
                row.innerHTML = '<td colspan="6" class="no-results">No weapons match your search</td>';
            } else {
                meleeScores.forEach(({ weapon, scores }) => {
                    const row = meleeTbody.insertRow();
                    const skillScoreClass = scores.skillScore > 0 ? 'style="color: green;"' : scores.skillScore < 0 ? 'style="color: red;"' : '';
                    const rowClass = weapon.mod ? 'modded-weapon' : '';
                    const weaponName = weapon.mod ? weapon.name : weapon.name;
                    const processedName = processWeaponNameWithLinks(weaponName, searchText);

                    row.className = rowClass;
                    row.innerHTML = `
                                            <td>${processedName}</td>
                                            <td>${scores.qualityDPS.toFixed(1)}</td>
                                            <td class="ap-value">${scores.ap.toFixed(3)}</td>
                                            <td>${scores.baseTotal.toFixed(1)}</td>
                                            <td ${skillScoreClass}>${scores.skillScore > 0 ? '+' : ''}${scores.skillScore !== 0 ? scores.skillScore.toFixed(0) : '0'}</td>
                                            <td class="score">${scores.total.toFixed(1)}</td>
                                        `;
                });
            }

            // Update weapon counts
            document.getElementById('rangedCount').textContent =
                filteredRangedWeapons.length === rangedWeapons.length ?
                    `(${filteredRangedWeapons.length})` :
                    `(${filteredRangedWeapons.length} of ${rangedWeapons.length})`;

            document.getElementById('meleeCount').textContent =
                filteredMeleeWeapons.length === meleeWeapons.length ?
                    `(${filteredMeleeWeapons.length})` :
                    `(${filteredMeleeWeapons.length} of ${meleeWeapons.length})`;

            // Update recommendation
            updateRecommendation(rangedMult, meleeMult, qualityMult, shootingSkill, meleeSkill,
                rangedCount > 0 ? totalRangedScore / rangedCount : 0,
                meleeCount > 0 ? totalMeleeScore / meleeCount : 0);
        }

        function updateRecommendation(rangedMult, meleeMult, qualityMult, shootingSkill, meleeSkill,
            avgRangedScore, avgMeleeScore) {
            const ratio = avgMeleeScore / avgRangedScore;
            const qualityName = document.getElementById('qualityLevel').options[document.getElementById('qualityLevel').selectedIndex].text;

            // Skill preference description
            let skillPref = "";
            const skillDiff = Math.abs(shootingSkill - meleeSkill);
            const skillBonus = skillDiff > 0 ? (30 * Math.pow(1.15, skillDiff - 1)).toFixed(0) : 0;
            const isBrawler = document.getElementById('brawlerTrait').checked;
            const isHunter = document.getElementById('hunterRole').checked;

            // Build trait/role description
            let traitDesc = "";
            if (isBrawler && isHunter) {
                traitDesc = " <strong>[Brawler: -500 ranged, +200 melee] + [Hunting: +100-300 ranged]</strong>";
            } else if (isBrawler) {
                traitDesc = " <strong style='color: red;'>[Brawler: -500 ranged, +200 melee]</strong>";
            } else if (isHunter) {
                traitDesc = " <strong style='color: green;'>[Hunting Work: +100/+200/+300 ranged by range]</strong>";
            }

            if (shootingSkill > meleeSkill + 3) {
                skillPref = `<p><strong>Skill Preference:</strong> Strong ranged preference (Shooting ${shootingSkill} vs Melee ${meleeSkill}). Ranged weapons get +${skillBonus} bonus.${traitDesc}</p>`;
            } else if (meleeSkill > shootingSkill + 3) {
                skillPref = `<p><strong>Skill Preference:</strong> Strong melee preference (Melee ${meleeSkill} vs Shooting ${shootingSkill}). Melee weapons get +${skillBonus} bonus.${traitDesc}</p>`;
            } else if (shootingSkill > meleeSkill) {
                skillPref = `<p><strong>Skill Preference:</strong> Slight ranged preference (Shooting ${shootingSkill} vs Melee ${meleeSkill}). Ranged weapons get +${skillBonus} bonus.${traitDesc}</p>`;
            } else if (meleeSkill > shootingSkill) {
                skillPref = `<p><strong>Skill Preference:</strong> Slight melee preference (Melee ${meleeSkill} vs Shooting ${shootingSkill}). Melee weapons get +${skillBonus} bonus.${traitDesc}</p>`;
            } else {
                skillPref = `<p><strong>Skill Preference:</strong> No preference (both skills at ${shootingSkill}).${traitDesc}</p>`;
            }

            // Filter awareness
            const filter = document.getElementById('weaponFilter').value;
            const filterNote = '';

            document.getElementById('recommendation').innerHTML = `
                                    <h3>Balance Analysis at ${qualityName}</h3>
                                    ${filterNote}
                                    ${skillPref}
                                    <p><strong>Average Ranged Score:</strong> ${avgRangedScore.toFixed(1)}</p>
                                    <p><strong>Average Melee Score:</strong> ${avgMeleeScore.toFixed(1)}</p>
                                    <hr>
                                    <h4>Current Configuration Notes:</h4>
                                    <ul>
                                    <ul>
                                        <li>Situational weapons (grenades, launchers) are capped at ~80 points to ensure they're only used when needed</li>
                                        <li>Ranged multiplier is set to 8 because ranged weapons are inherently superior - they allow kiting, safer engagement, and first strike advantage</li>
                                        <li>Melee multiplier of ${meleeMult} gives ${((meleeMult / rangedMult - 1) * 100).toFixed(0)}% bonus over ranged to compensate for close combat risks</li>
                                        <li>DPS and burst matter, but range enables kiting - short-range burst weapons penalized</li>
                                        <li>Burst bonus: +25/+15/+5 for extra shots, minus range penalties if under 20 range</li>
                                        <li>Heavy SMG (5-burst, 16 range) gets -28 burst penalty plus -20 extra penalty</li>
                                        <li>Quality affects both DPS and armor penetration values</li>
                                        <li>Armor penetration adds significant value for late-game effectiveness</li>
                                        <li>Skill scores use gradual exponential growth: Base 30 × 1.15^(levels-1)</li>
                                        <li>Pawn traits and work assignments will further modify these scores</li>
                                        <li>Brawler trait: -500 penalty for ranged, +200 bonus for melee weapons</li>
                                        <li>Hunting work: Range-based bonus (+300 for 30+ tiles, +200 for 20-29, +100 for &lt;20)</li>
                                    </ul>
                                    <h4>Notable Weapon Insights:</h4>
                                    <ul>
                                        <li><strong>Vanilla balance:</strong> Assault rifles properly dominate with burst fire AND good kiting range</li>
                                        <li><strong>Hunter preferences:</strong> Bolt-action and sniper rifles get +300 bonus, but hunters can still use melee if needed</li>
                                        <li><strong>Brawler penalties:</strong> -500 for ranged (reduced from -2000 - still avoid but better than nothing)</li>
                                        <li><strong>Minigun:</strong> Extreme DPS (25) but limited range (20) makes it situational</li>
                                        <li><strong>Bows vs Guns:</strong> Bows score lower but are silent and accessible early-game</li>
                                        <li><strong>Situational weapons:</strong> Grenades and launchers fixed at ~80 points (low priority for general use)</li>
                                        <li><strong>LMG:</strong> Good suppression with 6-burst but limited by 19 range - gets hunter penalty</li>
                                        <li><strong>Fists baseline:</strong> Everything beats unarmed combat (4.5 DPS)</li>
                                        <li><strong>[RS] Suppressor Cannon:</strong> Insane DPS (93.3) with 25-burst shows mod power creep</li>
                                        <li><strong>[RS] Anti-Mech Rifle:</strong> 55 damage and 75% AP makes it a late-game monster</li>
                                        <li><strong>[VWE] weapons:</strong> Generally well-balanced additions that fill vanilla gaps</li>
                                        <li><strong>Modded melee:</strong> [VWEL] Laser Sword approaches vanilla Plasmasword power</li>
                                        <li><strong>Range still matters:</strong> Even high-DPS modded weapons suffer with poor range</li>
                                    </ul>
                                `;
        }
    </script>
</body>
</html>