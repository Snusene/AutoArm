<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoArm Weapon Balance Analyzer</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Fix table structure and remove invisible spacing */
        table {
            table-layout: fixed !important;
            width: 100% !important;
            border-collapse: collapse !important;
        }

        /* Reset all table cells to ensure no hidden content */
        td, th {
            box-sizing: border-box !important;
            vertical-align: middle !important;
        }

        /* Different column widths for ranged vs melee tables */

        /* Ranged table - narrower columns to fit 8 in 60% width */
        #rangedTable td:first-child, #rangedTable th:first-child {
            width: 180px !important;
            max-width: 180px !important;
        }

        #rangedTable th:nth-child(2), #rangedTable td:nth-child(2) {
            width: 70px !important;
        }
        /* DPS */
        #rangedTable th:nth-child(3), #rangedTable td:nth-child(3) {
            width: 50px !important;
        }
        /* Acc */
        #rangedTable th:nth-child(4), #rangedTable td:nth-child(4) {
            width: 50px !important;
        }
        /* Burst */
        #rangedTable th:nth-child(5), #rangedTable td:nth-child(5) {
            width: 60px !important;
        }
        /* Range */
        #rangedTable th:nth-child(6), #rangedTable td:nth-child(6) {
            width: 60px !important;
        }
        /* AP */
        #rangedTable th:nth-child(7), #rangedTable td:nth-child(7) {
            width: 120px !important;
        }
        /* Total Score */

        /* Melee table - wider columns to use 5 in 40% width */
        #meleeTable td:first-child, #meleeTable th:first-child {
            width: 200px !important;
            max-width: 200px !important;
        }

        #meleeTable th:nth-child(2), #meleeTable td:nth-child(2) {
            width: 80px !important;
        }
        /* DPS */
        #meleeTable th:nth-child(3), #meleeTable td:nth-child(3) {
            width: 80px !important;
        }
        /* AP */
        #meleeTable th:nth-child(4), #meleeTable td:nth-child(4) {
            width: 120px !important;
        }
        /* Total Score */

        /* Common styles for all first columns */
        td:first-child, th:first-child {
            text-align: left !important;
            padding-left: 10px !important;
            padding-right: 10px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            position: relative !important;
        }

            /* Ensure no content before weapon names */
            td:first-child::before,
            th:first-child::before {
                content: none !important;
                display: none !important;
            }

        /* All other columns centered */
        td:not(:first-child), th:not(:first-child) {
            text-align: center !important;
            white-space: nowrap !important;
        }

        /* Narrower padding for ranged table */
        #rangedTable td:not(:first-child), #rangedTable th:not(:first-child) {
            padding: 4px 2px !important;
            font-size: 0.85em !important;
        }

        /* Normal padding for melee table */
        #meleeTable td:not(:first-child), #meleeTable th:not(:first-child) {
            padding: 6px 4px !important;
        }

        /* Special styling for situational weapons */
        .situational-weapon {
            background-color: rgba(255, 140, 0, 0.08) !important;
            border-left: 3px solid transparent !important;
            opacity: 0.85;
            transition: border-color 0.2s ease;
        }

            .situational-weapon:hover {
                opacity: 1;
                border-left-color: #ff8c00 !important;
            }

            .situational-weapon td:first-child {
                font-style: italic;
                color: #ff8c00;
            }

                .situational-weapon td:first-child::after {
                    content: " ⚠";
                    font-style: normal;
                    cursor: help;
                }

            .situational-weapon .score {
                color: #ff8c00 !important;
                font-weight: bold;
            }

        /* Add separator before situational weapons */
        .situational-separator {
            position: relative;
        }

            .situational-separator td {
                padding-top: 20px !important;
            }

                .situational-separator td:first-child::before {
                    content: "⚠ SITUATIONAL WEAPONS ⚠";
                    position: absolute;
                    top: 3px;
                    left: 10px;
                    color: #ff8c00;
                    font-size: 0.75em;
                    font-weight: bold;
                    letter-spacing: 1px;
                    opacity: 0.8;
                }
    </style>
</head>
<body>
    <div class="container">
        <div id="loadingMessage" class="loading">Loading weapon data...</div>
        <div id="errorMessage" class="error" style="display: none;"></div>

        <div id="mainContent" style="display: none;">
            <div class="quality-info">
                <h4>AutoArm Weapon Scoring System</h4>
                <p>This interactive tool lets you visualize how AutoArm evaluates weapons. <strong>The higher the score, the more likely a colonist is to upgrade to that weapon.</strong> Scores are based on:</p>
                <ul>
                    <li><strong>DPS (Damage Per Second):</strong> Core weapon effectiveness</li>
                    <li><strong>Accuracy:</strong> Hit chance at different ranges (weighted average)</li>
                    <li><strong>Range:</strong> Kiting potential and tactical flexibility</li>
                    <li><strong>Burst Fire:</strong> Multiple shots with diminishing returns</li>
                    <li><strong>Armor Penetration:</strong> Effectiveness against late-game threats</li>
                    <li><strong>Skill Preferences:</strong> Colonist shooting vs melee skills</li>
                    <li><strong>Power Creep Protection:</strong> Extreme DPS (>30) has diminishing returns to prevent modded weapons from breaking balance</li>
                    <li><strong>Situational Weapons:</strong> Grenades, launchers, and utility weapons are capped at ~80 points to ensure they're only chosen for specific tasks</li>
                </ul>
                <p style="font-style: italic; color: #8f98a0; margin-top: 10px; font-weight: 500; text-align: center;">Developer note: I use this when fine-tuning AutoArm's weapon scoring balance. I had way too much fun styling this page.</p>
                <div class="note" style="margin-top: 15px;">
                    <p><strong>About this system:</strong> Since vanilla RimWorld lacks automatic weapon equipping and therefore has no weapon evaluation formula to reference, AutoArm creates its own scoring system from scratch. No formula is perfect for every playstyle, but this aims to work well for most situations while also trying to respect modded behaviors (e.g., "Hunters Use Melee" mods).</p>
                    <p><strong>Performance note:</strong> To keep AutoArm fast even with hundreds of modded weapons, the scoring system focuses only on these core factors. Additional mechanics like weapon warmup times, weather effects, or other colonist traits would add minimal accuracy improvement while significantly impacting performance.</p>
                    <p><strong>Override options:</strong> Force-equip weapons (right-click) to prevent replacement, or use outfit filters to restrict weapon types per colonist.</p>
                </div>
            </div>

            <div class="controls">
                <h3>Scoring Configuration</h3>
                <div class="control-row">
                    <div class="control-group">
                        <label>Weapon Quality:</label>
                        <select id="qualityLevel" onchange="updateScores()">
                            <option value="0.5">Awful (50%)</option>
                            <option value="0.8">Poor (80%)</option>
                            <option value="1.0" selected>Normal (100%)</option>
                            <option value="1.15">Good (115%)</option>
                            <option value="1.3">Excellent (130%)</option>
                            <option value="1.45">Masterwork (145%)</option>
                            <option value="1.6">Legendary (160%)</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Show Weapons:</label>
                        <select id="weaponFilter" onchange="filterWeapons(); updateScores()">
                            <option value="vanilla" selected>Vanilla Only</option>
                            <option value="all">Vanilla + Modded</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Search:</label>
                        <div class="search-container">
                            <input type="text" id="weaponSearch" placeholder="e.g. rifle, [VWE], sword..." oninput="handleSearchInput()">
                            <span class="clear-search" onclick="clearSearch()">×</span>
                        </div>
                    </div>
                </div>
                <div class="control-row">
                    <div class="control-group">
                        <label>Shooting Skill:</label>
                        <input type="range" id="shootingSkill" min="0" max="20" value="10" oninput="updateSkillDisplay(this, 'shootingDisplay'); updateScores()">
                        <span id="shootingDisplay" style="width: 30px; display: inline-block; color: #66c0f4; font-weight: bold;">10</span>
                    </div>
                    <div class="control-group">
                        <label>Melee Skill:</label>
                        <input type="range" id="meleeSkill" min="0" max="20" value="10" oninput="updateSkillDisplay(this, 'meleeDisplay'); updateScores()">
                        <span id="meleeDisplay" style="width: 30px; display: inline-block; color: #66c0f4; font-weight: bold;">10</span>
                    </div>
                    <div class="control-group">
                        <label><input type="checkbox" id="brawlerTrait" onchange="updateScores()"> Brawler</label>
                    </div>
                    <div class="control-group">
                        <label><input type="checkbox" id="hunterRole" onchange="updateScores()"> Hunting</label>
                    </div>
                </div>
            </div>

            <div class="comparison">
                <div class="weapon-section">
                    <h2>Ranged Weapons <span id="rangedCount" style="font-size: 0.8em; color: #666;"></span></h2>
                    <div class="table-container">
                        <table id="rangedTable">
                            <thead>
                                <tr>
                                    <th>Weapon</th>
                                    <th>DPS (w/Q)</th>
                                    <th>Acc</th>
                                    <th>Burst</th>
                                    <th>Range</th>
                                    <th>AP</th>
                                    <th>Total Score</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="weapon-section">
                    <h2>Melee Weapons <span id="meleeCount" style="font-size: 0.8em; color: #666;"></span></h2>
                    <div class="table-container">
                        <table id="meleeTable">
                            <thead>
                                <tr>
                                    <th>Weapon</th>
                                    <th>DPS (w/Q)</th>
                                    <th>AP</th>
                                    <th>Total Score</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="recommendation" id="recommendation"></div>

            <!-- Performance Test Section -->
            <div class="performance-test-section" style="margin-top: 40px; border-top: 2px solid #333; padding-top: 20px;">
                <h2>Performance Analysis Tool</h2>
                <div class="quality-info" style="background: #1e2329; border-left: 4px solid #66c0f4; padding: 15px; margin: 15px 0;">
                    <p><strong>Test the performance impact of proposed optimizations!</strong> This tool compares the current weapon scoring system with an optimized version that:</p>
                    <ul>
                        <li>Caches static weapon properties to avoid recalculation</li>
                        <li>Merges range modifier and bonus calculations</li>
                        <li>Simplifies burst bonus formula</li>
                        <li>Removes AP estimation for melee weapons</li>
                    </ul>
                </div>
                
                <div class="controls" style="background: #171a21; padding: 20px; border-radius: 8px;">
                    <h3>Performance Test Configuration</h3>
                    <div class="control-row">
                        <div class="control-group">
                            <label>Test Weapons:</label>
                            <input type="number" id="perfWeaponCount" value="50" min="10" max="200" style="width: 80px;">
                        </div>
                        <div class="control-group">
                            <label>Test Pawns:</label>
                            <input type="number" id="perfPawnCount" value="10" min="1" max="50" style="width: 80px;">
                        </div>
                        <div class="control-group">
                            <label>Iterations:</label>
                            <input type="number" id="perfIterations" value="100" min="10" max="1000" style="width: 80px;">
                        </div>
                    </div>
                    <div class="control-row" style="margin-top: 15px;">
                        <button onclick="runPerformanceTest()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Run Performance Test</button>
                        <button onclick="runAccuracyTest()" style="padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Run Accuracy Test</button>
                        <button onclick="runFullPerfTest()" style="padding: 10px 20px; background: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer;">Run Both Tests</button>
                    </div>
                </div>

                <div id="perfResults" style="display: none; margin-top: 20px;">
                    <div class="comparison" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="weapon-section">
                            <h3>Current System</h3>
                            <div class="perf-metrics" id="currentPerfMetrics" style="background: #1e2329; padding: 15px; border-radius: 4px;"></div>
                        </div>
                        <div class="weapon-section">
                            <h3>Optimized System</h3>
                            <div class="perf-metrics" id="optimizedPerfMetrics" style="background: #1e2329; padding: 15px; border-radius: 4px;"></div>
                        </div>
                    </div>
                </div>

                <div id="accuracyTestResults" style="display: none; margin-top: 20px;">
                    <h3>Scoring Accuracy Comparison</h3>
                    <div id="accuracyTable" style="background: #1e2329; padding: 15px; border-radius: 4px; overflow-x: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load the external weapon data file -->
    <script src="weapons-data.js" onerror="handleWeaponDataError()"></script>

    <script>
        // Initialize weapon arrays
        let vanillaRangedWeapons = [];
        let vanillaMeleeWeapons = [];
        let moddedRangedWeapons = [];
        let moddedMeleeWeapons = [];
        let rangedWeapons = [];
        let meleeWeapons = [];

        // Handle loading error
        function handleWeaponDataError() {
            console.error('Failed to load weapons-data.js');
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorMessage').innerHTML =
                '<strong>Error:</strong> Failed to load weapons-data.js<br>' +
                'Please make sure:<br>' +
                '1. weapons-data.js is in the same folder as index.html<br>' +
                '2. The file name is exactly "weapons-data.js" (case sensitive)<br>' +
                '3. If running locally, use a web server (not file://)';
        }

        // Function to initialize the application
        function initializeApp() {
            console.log('Attempting to initialize app...');
            console.log('window.weaponData exists?', !!window.weaponData);

            try {
                if (window.weaponData) {
                    console.log('Loading weapon data...');

                    // Load weapon data from external file
                    vanillaRangedWeapons = window.weaponData.vanillaRangedWeapons || [];
                    vanillaMeleeWeapons = window.weaponData.vanillaMeleeWeapons || [];
                    moddedRangedWeapons = window.weaponData.moddedRangedWeapons || [];
                    moddedMeleeWeapons = window.weaponData.moddedMeleeWeapons || [];

                    console.log('Loaded weapons:', {
                        vanillaRanged: vanillaRangedWeapons.length,
                        vanillaMelee: vanillaMeleeWeapons.length,
                        moddedRanged: moddedRangedWeapons.length,
                        moddedMelee: moddedMeleeWeapons.length
                    });

                    // Initialize with vanilla weapons
                    filterWeapons();

                    // Hide loading message and show main content
                    document.getElementById('loadingMessage').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';

                    // Initial update
                    updateScores();

                    console.log('Application initialized successfully!');
                } else {
                    throw new Error('window.weaponData is undefined');
                }
            } catch (error) {
                console.error('Error during initialization:', error);
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').innerHTML =
                    '<strong>Error:</strong> ' + error.message + '<br>' +
                    'Check the browser console (F12) for more details.';
            }
        }

        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function () {
                // Give the weapons-data.js script a moment to execute
                setTimeout(initializeApp, 100);
            });
        } else {
            // DOM is already ready, wait a moment for weapons-data.js
            setTimeout(initializeApp, 100);
        }

        // Add keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            // Ctrl/Cmd + F to focus search
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                document.getElementById('weaponSearch').focus();
            }
            // Escape to clear search
            else if (e.key === 'Escape') {
                const searchBox = document.getElementById('weaponSearch');
                if (searchBox.value) {
                    clearSearch();
                }
            }
            // V to toggle vanilla/all weapons
            else if (e.key === 'v' && !e.ctrlKey && !e.metaKey && !e.altKey) {
                const activeElement = document.activeElement;
                if (activeElement.tagName !== 'INPUT') {
                    const filter = document.getElementById('weaponFilter');
                    filter.value = filter.value === 'vanilla' ? 'all' : 'vanilla';
                    filterWeapons();
                    updateScores();
                }
            }
        });

        // Workshop mod URLs mapping
        const modWorkshopUrls = {
            '[VWE]': 'https://steamcommunity.com/sharedfiles/filedetails/?id=1814383360', // Vanilla Weapons Expanded
            '[VWEQ]': 'https://steamcommunity.com/sharedfiles/filedetails/?id=1906780517', // VWE - Quickdraw
            '[VWEF]': 'https://steamcommunity.com/sharedfiles/filedetails/?id=2023513450', // VWE - Frontier
            '[VWEH]': 'https://steamcommunity.com/sharedfiles/filedetails/?id=2329126791', // VWE - Heavy Weapons
            '[VWEB]': 'https://steamcommunity.com/sharedfiles/filedetails/?id=2854967482', // VWE - Bioferrite (might be Anomaly weapons)
            '[VWEL]': 'https://steamcommunity.com/sharedfiles/filedetails/?id=1814987817', // VWE - Laser
            '[RS]': 'https://steamcommunity.com/sharedfiles/filedetails/?id=849231601', // Rimsenal - Core
            '[RSA]': 'https://steamcommunity.com/sharedfiles/filedetails/?id=849232906', // Rimsenal - Augmented
            '[CE]': 'https://steamcommunity.com/sharedfiles/filedetails/?id=2890901044', // Combat Extended
            '[W+]': 'https://steamcommunity.com/sharedfiles/filedetails/?id=1528163280', // Weapons+
            '[MT]': 'https://steamcommunity.com/sharedfiles/filedetails/?id=2007052872', // Medieval Times
            '[40K]': 'https://steamcommunity.com/workshop/browse/?appid=294100&searchtext=warhammer+40k+weapons', // Warhammer 40K (search)
            '[SW]': 'https://steamcommunity.com/workshop/browse/?appid=294100&searchtext=star+wars+weapons', // Star Wars (search)
            '[XCOM]': 'https://steamcommunity.com/workshop/browse/?appid=294100&searchtext=xcom+weapons', // XCOM (search)
            '[TF]': 'https://steamcommunity.com/workshop/browse/?appid=294100&searchtext=titanfall+weapons', // Titanfall (search)
            '[ME]': 'https://steamcommunity.com/workshop/browse/?appid=294100&searchtext=mass+effect+weapons', // Mass Effect (search)
            '[BB]': 'https://steamcommunity.com/workshop/browse/?appid=294100&searchtext=bloodborne+weapons', // Bloodborne (search)
            '[SK]': 'https://steamcommunity.com/workshop/browse/?appid=294100&searchtext=skyrim+weapons'  // Skyrim (search)
        };

        // Cache for processed weapon names to improve performance
        const weaponNameCache = new Map();

        function processWeaponNameWithLinks(weaponName, searchText) {
            // Check cache first
            const cacheKey = weaponName;
            if (weaponNameCache.has(cacheKey)) {
                return weaponNameCache.get(cacheKey);
            }

            // Process mod tags to make them clickable
            let processedName = weaponName;

            // Replace mod tags with clickable links
            const modTagRegex = /(\[[^\]]+\])/g;
            processedName = processedName.replace(modTagRegex, (match) => {
                const url = modWorkshopUrls[match];
                if (url) {
                    return `<a href="${url}" target="_blank" class="mod-link" title="View on Steam Workshop">${match}</a>`;
                }
                return match;
            });

            // Cache the result
            weaponNameCache.set(cacheKey, processedName);

            return processedName;
        }

        function updateSkillDisplay(slider, displayId) {
            document.getElementById(displayId).textContent = slider.value;
            // Update the visual fill of the range slider
            const percent = ((slider.value - slider.min) / (slider.max - slider.min)) * 100;
            slider.style.setProperty('--range-percent', percent + '%');
        }

        // Debounced search handler for better performance
        let searchTimeout;
        function handleSearchInput() {
            const searchBox = document.getElementById('weaponSearch');
            const clearButton = document.querySelector('.clear-search');

            if (searchBox.value.length > 0) {
                clearButton.style.display = 'block';
            } else {
                clearButton.style.display = 'none';
            }

            // Debounce the search to avoid excessive updates
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                updateScores();
            }, 300); // Wait 300ms after user stops typing
        }

        function clearSearch() {
            document.getElementById('weaponSearch').value = '';
            document.querySelector('.clear-search').style.display = 'none';
            updateScores();
        }

        function calculateArmorPenetrationScore(ap) {
            // Based on the C# implementation thresholds
            if (ap >= 0.75) // Can penetrate marine armor
                return 100; // Reduced further
            else if (ap >= 0.52) // Can penetrate flak vest
                return 70;  // Reduced further
            else if (ap >= 0.40) // Can penetrate recon armor
                return 50;  // Reduced further
            else if (ap >= 0.20) // Can penetrate basic armor
                return 30;  // Reduced further
            else
                return ap * 60; // Reduced further - Linear scale for low AP
        }

        // Updated skill scoring with gradual exponential growth
        function calculateSkillScore(shootingSkill, meleeSkill, isRanged) {
            const skillDifference = Math.abs(shootingSkill - meleeSkill);
            const isBrawler = document.getElementById('brawlerTrait').checked;
            const isHunter = document.getElementById('hunterRole').checked;

            let baseScore = 0;

            if (skillDifference > 0) {
                // Start with base bonus of 30 for 1 level difference
                // Increase by 15% for each additional level (exponential growth)
                const baseBonus = 30;
                const growthRate = 1.15;
                const bonus = baseBonus * Math.pow(growthRate, skillDifference - 1);

                // Apply bonus or penalty based on weapon type
                if (isRanged) {
                    if (shootingSkill > meleeSkill) {
                        baseScore = bonus; // Positive bonus for matching skill
                    } else {
                        baseScore = -bonus * 0.5; // Half penalty for wrong type
                    }
                } else {
                    if (meleeSkill > shootingSkill) {
                        baseScore = bonus; // Positive bonus for matching skill
                    } else {
                        baseScore = -bonus * 0.5; // Half penalty for wrong type
                    }
                }
            }

            // Apply trait/role modifiers
            if (isBrawler) {
                if (isRanged) {
                    baseScore -= 500; // Brawler penalty for ranged weapons
                } else {
                    baseScore += 200; // Brawler bonus for melee weapons
                }
            }

            if (isHunter) {
                if (isRanged) {
                    // Base hunter bonus for any ranged weapon
                    baseScore += 100; // This gives the minimum +100 for all ranged
                }
                // No penalty for melee - hunters just prefer ranged
            }

            return baseScore;
        }

        function filterWeapons() {
            const filter = document.getElementById('weaponFilter').value;

            if (filter === 'vanilla') {
                rangedWeapons = [...vanillaRangedWeapons];
                meleeWeapons = [...vanillaMeleeWeapons];
            } else {
                rangedWeapons = [...vanillaRangedWeapons, ...moddedRangedWeapons];
                meleeWeapons = [...vanillaMeleeWeapons, ...moddedMeleeWeapons];
            }
        }

        // Cache for weapon base scores
        const weaponBaseScoreCache = new Map();

        function calculateRangedScore(weapon, multiplier, qualityMult, shootingSkill, meleeSkill) {
            // Check cache first
            const cacheKey = `${weapon.name}_${qualityMult}`;
            let baseScore = 0;
            
            if (weaponBaseScoreCache.has(cacheKey)) {
                baseScore = weaponBaseScoreCache.get(cacheKey);
            } else {
                // Calculate base score (weapon-specific, not pawn-specific)
                baseScore = calculateRangedBaseScore(weapon, multiplier, qualityMult);
                weaponBaseScoreCache.set(cacheKey, baseScore);
            }
            
            // Add pawn-specific modifiers
            const skillScore = calculateSkillScore(shootingSkill, meleeSkill, true);
            
            return {
                baseDPS: weapon.dps,
                qualityDPS: weapon.dps * (weapon.noQuality ? 1 : qualityMult),
                ap: (weapon.ap || (weapon.damage || weapon.dps * 2) * 0.015) * (weapon.noQuality ? 1 : qualityMult),
                accuracy: weapon.situational ? 1.0 : 0.65, // Simplified
                baseTotal: baseScore,
                skillScore: skillScore,
                total: baseScore + skillScore
            };
        }
        
        function calculateRangedBaseScore(weapon, multiplier, qualityMult) {
            // Apply situational weapon penalty
            if (weapon.situational) {
                return 80; // Cap for situational weapons
            }

            // Apply quality to DPS
            let qualityDPS = weapon.dps * (weapon.noQuality ? 1 : qualityMult);

            // Power creep protection
            let adjustedDPS = qualityDPS;
            if (qualityDPS > 30) {
                const excess = qualityDPS - 30;
                adjustedDPS = 30 + (excess * 0.5);
            }

            let baseScore = adjustedDPS * multiplier;

            // Combined range scoring (optimized)
            const rangeScore = getCombinedRangeScore(weapon.range);
            baseScore *= rangeScore.multiplier;
            baseScore += rangeScore.bonus;

            // Simplified burst bonus (optimized)
            if (weapon.burst > 1) {
                baseScore += 10 * Math.log(weapon.burst + 1);
            }

            // Add AP score
            let weaponAP = weapon.ap || ((weapon.damage || weapon.dps * 2) * 0.015);
            weaponAP = weaponAP * (weapon.noQuality ? 1 : qualityMult);
            baseScore += calculateArmorPenetrationScore(weaponAP);

            return baseScore;
        }

        // Optimized combined range calculation
        function getCombinedRangeScore(range) {
            if (range < 10) return { multiplier: 0.30, bonus: 0 };
            else if (range < 14) return { multiplier: 0.40, bonus: 0 };
            else if (range < 18) return { multiplier: 0.55, bonus: 0 };
            else if (range < 22) return { multiplier: 0.90, bonus: 2 };
            else if (range < 25) return { multiplier: 0.95, bonus: 5 };
            else if (range < 30) return { multiplier: 1.0, bonus: 10 };
            else if (range < 35) return { multiplier: 1.0, bonus: 15 };
            else return { multiplier: 1.02, bonus: 20 };
        }

        function calculateMeleeScore(weapon, multiplier, qualityMult, shootingSkill, meleeSkill) {
            // Check cache first
            const cacheKey = `${weapon.name}_melee_${qualityMult}`;
            let baseScore = 0;
            
            if (weaponBaseScoreCache.has(cacheKey)) {
                baseScore = weaponBaseScoreCache.get(cacheKey);
            } else {
                // Calculate base score (weapon-specific, not pawn-specific)
                baseScore = calculateMeleeBaseScore(weapon, multiplier, qualityMult);
                weaponBaseScoreCache.set(cacheKey, baseScore);
            }
            
            // Add pawn-specific modifiers
            const skillScore = calculateSkillScore(shootingSkill, meleeSkill, false);
            
            return {
                baseDPS: weapon.dps,
                qualityDPS: weapon.dps * (weapon.noQuality ? 1 : qualityMult),
                ap: weapon.ap * (weapon.noQuality ? 1 : qualityMult),
                baseTotal: baseScore,
                skillScore: skillScore,
                total: baseScore + skillScore
            };
        }
        
        function calculateMeleeBaseScore(weapon, multiplier, qualityMult) {
            // Apply quality to DPS
            let qualityDPS = weapon.dps * (weapon.noQuality ? 1 : qualityMult);

            // Power creep protection
            let adjustedDPS = qualityDPS;
            if (qualityDPS > 30) {
                const excess = qualityDPS - 30;
                adjustedDPS = 30 + (excess * 0.5);
            }

            let baseScore = adjustedDPS * multiplier;

            // Add AP score (no estimation for melee - optimized)
            let weaponAP = weapon.ap * (weapon.noQuality ? 1 : qualityMult);
            baseScore += calculateArmorPenetrationScore(weaponAP);

            return baseScore;
        }

        function updateScores() {
            const rangedMult = 10; // Fixed multiplier for ranged weapons
            const meleeMult = 8; // Fixed multiplier for melee weapons
            const qualityMult = parseFloat(document.getElementById('qualityLevel').value);
            const shootingSkill = parseInt(document.getElementById('shootingSkill').value);
            const meleeSkill = parseInt(document.getElementById('meleeSkill').value);
            const searchText = document.getElementById('weaponSearch').value.toLowerCase();

            // Update ranged weapons table
            const rangedTbody = document.querySelector('#rangedTable tbody');

            // Clear ALL content using innerHTML first to ensure clean slate
            rangedTbody.innerHTML = '';

            let totalRangedScore = 0;
            let rangedCount = 0;

            // Filter weapons based on search text
            const filteredRangedWeapons = rangedWeapons.filter(weapon => {
                const searchableText = weapon.name.toLowerCase();
                const searchTerms = searchText.split(' ').filter(term => term.length > 0);

                // If no search terms, show all
                if (searchTerms.length === 0) return true;

                // Check if all search terms are found in the weapon name
                return searchTerms.every(term => searchableText.includes(term));
            });

            // Calculate scores for all weapons first
            const rangedScores = filteredRangedWeapons.map(weapon => {
                const scores = calculateRangedScore(weapon, rangedMult, qualityMult, shootingSkill, meleeSkill);
                totalRangedScore += scores.total;
                rangedCount++;
                return { weapon, scores };
            });

            // Sort by total score (highest first), but situational weapons go to bottom
            rangedScores.sort((a, b) => {
                // Situational weapons always go to the bottom
                if (a.weapon.situational && !b.weapon.situational) return 1;
                if (!a.weapon.situational && b.weapon.situational) return -1;
                // Otherwise sort by score
                return b.scores.total - a.scores.total;
            });

            // Calculate dynamic tier thresholds based on percentiles (excluding situational weapons)
            let rangedTierThresholds = { legendary: 0, excellent: 0, good: 0, average: 0 };
            const nonSituationalScores = rangedScores.filter(item => !item.weapon.situational);
            if (nonSituationalScores.length > 0) {
                const scores = nonSituationalScores.map(item => item.scores.total);
                rangedTierThresholds.legendary = scores[Math.floor(scores.length * 0.1)] || scores[0]; // Top 10%
                rangedTierThresholds.excellent = scores[Math.floor(scores.length * 0.25)] || scores[0]; // Top 25%
                rangedTierThresholds.good = scores[Math.floor(scores.length * 0.5)] || scores[0]; // Top 50%
                rangedTierThresholds.average = scores[Math.floor(scores.length * 0.75)] || scores[0]; // Top 75%
            }

            // Add sorted rows to table
            if (rangedScores.length === 0) {
                rangedTbody.innerHTML = '<tr><td colspan="7" class="no-results">No weapons match your search</td></tr>';
            } else {
                // Build complete HTML string first
                let tableHTML = '';
                let firstSituational = true;
                rangedScores.forEach(({ weapon, scores }, index) => {
                    const burstText = weapon.burst > 1 ? `${weapon.burst}x` : '-';
                    // Process weapon name with mod links
                    const weaponName = processWeaponNameWithLinks(weapon.name.trim(), searchText);
                    const weaponDisplay = weapon.noQuality ?
                        `${weaponName} <span style="color: #888; font-size: 0.8em;">[Natural]</span>` :
                        weaponName;

                    // Display accuracy as "-" for situational weapons
                    const accuracyDisplay = weapon.situational ? '-' : `${(scores.accuracy * 100).toFixed(0)}%`;

                    // Add tier classification based on dynamic thresholds
                    let tierClass = '';
                    if (!weapon.situational) {
                        if (scores.total >= rangedTierThresholds.legendary) tierClass = 'legendary-tier';
                        else if (scores.total >= rangedTierThresholds.excellent) tierClass = 'excellent-tier';
                        else if (scores.total >= rangedTierThresholds.good) tierClass = 'good-tier';
                        else if (scores.total >= rangedTierThresholds.average) tierClass = 'average-tier';
                        else tierClass = 'poor-tier';
                    }

                    // Add separator before first situational weapon
                    let separatorClass = '';
                    if (weapon.situational && firstSituational) {
                        separatorClass = 'situational-separator';
                        firstSituational = false;
                    }

                    const rowClass = weapon.mod ? 'modded-weapon' : '';
                    const situationalClass = weapon.situational ? 'situational-weapon' : '';
                    const rowClasses = `${rowClass} ${tierClass} ${situationalClass} ${separatorClass}`.trim();

                    const skillScoreSign = scores.skillScore > 0 ? '+' : '';
                    const dpsDisplay = scores.qualityDPS > 30 ?
                        `<span class="power-creep-adjusted tooltip" data-tooltip="Original DPS: ${scores.qualityDPS.toFixed(1)}">${((scores.baseDPS * qualityMult) > 30 ? (30 + ((scores.baseDPS * qualityMult - 30) * 0.5)) : (scores.baseDPS * qualityMult)).toFixed(1)}</span>` :
                        scores.qualityDPS.toFixed(1);

                    // Create total score with skill modifier shown
                    const totalScoreDisplay = weapon.situational ?
                        `<span class="score" style="font-style: italic;">~${scores.total.toFixed(0)}</span>` :
                        (scores.skillScore !== 0 ?
                            `<span class="score">${scores.total.toFixed(1)}</span> <span style="font-size: 0.8em; color: ${scores.skillScore > 0 ? 'green' : 'red'};">(${skillScoreSign}${scores.skillScore.toFixed(0)})</span>` :
                            `<span class="score">${scores.total.toFixed(1)}</span>`);

                    tableHTML += `<tr class="${rowClasses}">
                            <td>${weaponDisplay}</td>
                            <td>${dpsDisplay}</td>
                            <td class="acc-value">${accuracyDisplay}</td>
                            <td>${burstText}</td>
                            <td>${weapon.range}</td>
                            <td class="ap-value">${scores.ap.toFixed(3)}</td>
                            <td>${totalScoreDisplay}</td>
                        </tr>`;
                });

                // Set all HTML at once
                rangedTbody.innerHTML = tableHTML;
            }

            // Update melee weapons table
            const meleeTbody = document.querySelector('#meleeTable tbody');

            // Clear ALL content
            meleeTbody.innerHTML = '';

            let totalMeleeScore = 0;
            let meleeCount = 0;

            // Filter weapons based on search text
            const filteredMeleeWeapons = meleeWeapons.filter(weapon => {
                const searchableText = weapon.name.toLowerCase();
                const searchTerms = searchText.split(' ').filter(term => term.length > 0);

                // If no search terms, show all
                if (searchTerms.length === 0) return true;

                // Check if all search terms are found in the weapon name
                return searchTerms.every(term => searchableText.includes(term));
            });

            // Calculate scores for all weapons first
            const meleeScores = filteredMeleeWeapons.map(weapon => {
                const scores = calculateMeleeScore(weapon, meleeMult, qualityMult, shootingSkill, meleeSkill);
                totalMeleeScore += scores.total;
                meleeCount++;
                return { weapon, scores };
            });

            // Sort by total score (highest first)
            meleeScores.sort((a, b) => b.scores.total - a.scores.total);

            // Calculate dynamic tier thresholds based on percentiles
            let meleeTierThresholds = { legendary: 0, excellent: 0, good: 0, average: 0 };
            if (meleeScores.length > 0) {
                const scores = meleeScores.map(item => item.scores.total);
                meleeTierThresholds.legendary = scores[Math.floor(scores.length * 0.1)] || scores[0]; // Top 10%
                meleeTierThresholds.excellent = scores[Math.floor(scores.length * 0.25)] || scores[0]; // Top 25%
                meleeTierThresholds.good = scores[Math.floor(scores.length * 0.5)] || scores[0]; // Top 50%
                meleeTierThresholds.average = scores[Math.floor(scores.length * 0.75)] || scores[0]; // Top 75%
            }

            // Add sorted rows to table
            if (meleeScores.length === 0) {
                meleeTbody.innerHTML = '<tr><td colspan="4" class="no-results">No weapons match your search</td></tr>';
            } else {
                // Build complete HTML string first
                let tableHTML = '';
                meleeScores.forEach(({ weapon, scores }, index) => {
                    // Process weapon name with mod links
                    const weaponName = processWeaponNameWithLinks(weapon.name.trim(), searchText);
                    const weaponDisplay = weapon.noQuality ?
                        `${weaponName} <span style="color: #888; font-size: 0.8em;">[Natural]</span>` :
                        weaponName;

                    // Add tier classification based on dynamic thresholds
                    let tierClass = '';
                    if (scores.total >= meleeTierThresholds.legendary) tierClass = 'legendary-tier';
                    else if (scores.total >= meleeTierThresholds.excellent) tierClass = 'excellent-tier';
                    else if (scores.total >= meleeTierThresholds.good) tierClass = 'good-tier';
                    else if (scores.total >= meleeTierThresholds.average) tierClass = 'average-tier';
                    else tierClass = 'poor-tier';

                    const rowClass = weapon.mod ? 'modded-weapon' : '';
                    const rowClasses = `${rowClass} ${tierClass}`.trim();

                    const skillScoreSign = scores.skillScore > 0 ? '+' : '';
                    const dpsDisplay = scores.qualityDPS > 30 ?
                        `<span class="power-creep-adjusted tooltip" data-tooltip="Original DPS: ${scores.qualityDPS.toFixed(1)}">${((scores.baseDPS * qualityMult) > 30 ? (30 + ((scores.baseDPS * qualityMult - 30) * 0.5)) : (scores.baseDPS * qualityMult)).toFixed(1)}</span>` :
                        scores.qualityDPS.toFixed(1);

                    // Create total score with skill modifier shown
                    const totalScoreDisplay = scores.skillScore !== 0 ?
                        `<span class="score">${scores.total.toFixed(1)}</span> <span style="font-size: 0.8em; color: ${scores.skillScore > 0 ? 'green' : 'red'};">(${skillScoreSign}${scores.skillScore.toFixed(0)})</span>` :
                        `<span class="score">${scores.total.toFixed(1)}</span>`;

                    tableHTML += `<tr class="${rowClasses}">
                            <td>${weaponDisplay}</td>
                            <td>${dpsDisplay}</td>
                            <td class="ap-value">${scores.ap.toFixed(3)}</td>
                            <td>${totalScoreDisplay}</td>
                        </tr>`;
                });

                // Set all HTML at once
                meleeTbody.innerHTML = tableHTML;
            }

            // Update weapon counts
            document.getElementById('rangedCount').textContent =
                filteredRangedWeapons.length === rangedWeapons.length ?
                    `(${filteredRangedWeapons.length})` :
                    `(${filteredRangedWeapons.length} of ${rangedWeapons.length})`;

            document.getElementById('meleeCount').textContent =
                filteredMeleeWeapons.length === meleeWeapons.length ?
                    `(${filteredMeleeWeapons.length})` :
                    `(${filteredMeleeWeapons.length} of ${meleeWeapons.length})`;

            // Update recommendation
            updateRecommendation(rangedMult, meleeMult, qualityMult, shootingSkill, meleeSkill,
                rangedCount > 0 ? totalRangedScore / rangedCount : 0,
                meleeCount > 0 ? totalMeleeScore / meleeCount : 0);

            // Debug: Log the first row structure
            const firstRow = rangedTbody.querySelector('tr');
            if (firstRow) {
                console.log('First row cell count:', firstRow.cells.length);
                console.log('Expected columns: 7 for ranged, 4 for melee');
            }
        }

        function updateRecommendation(rangedMult, meleeMult, qualityMult, shootingSkill, meleeSkill,
            avgRangedScore, avgMeleeScore) {
            const ratio = avgMeleeScore / avgRangedScore;
            const qualityName = document.getElementById('qualityLevel').options[document.getElementById('qualityLevel').selectedIndex].text;

            // Skill preference description
            let skillPref = "";
            const skillDiff = Math.abs(shootingSkill - meleeSkill);
            const skillBonus = skillDiff > 0 ? (30 * Math.pow(1.15, skillDiff - 1)).toFixed(0) : 0;
            const isBrawler = document.getElementById('brawlerTrait').checked;
            const isHunter = document.getElementById('hunterRole').checked;

            // Build trait/role description
            let traitDesc = "";
            if (isBrawler && isHunter) {
                traitDesc = " <strong>[Brawler: -500 ranged, +200 melee] + [Hunting: +100 ranged]</strong>";
            } else if (isBrawler) {
                traitDesc = " <strong style='color: red;'>[Brawler: -500 ranged, +200 melee]</strong>";
            } else if (isHunter) {
                traitDesc = " <strong style='color: green;'>[Hunting: +100 for all ranged weapons]</strong>";
            }

            if (shootingSkill > meleeSkill + 3) {
                skillPref = `<p><strong>Skill Preference:</strong> Strong ranged preference (Shooting ${shootingSkill} vs Melee ${meleeSkill}). Ranged weapons get +${skillBonus} bonus.${traitDesc}</p>`;
            } else if (meleeSkill > shootingSkill + 3) {
                skillPref = `<p><strong>Skill Preference:</strong> Strong melee preference (Melee ${meleeSkill} vs Shooting ${shootingSkill}). Melee weapons get +${skillBonus} bonus.${traitDesc}</p>`;
            } else if (shootingSkill > meleeSkill) {
                skillPref = `<p><strong>Skill Preference:</strong> Slight ranged preference (Shooting ${shootingSkill} vs Melee ${meleeSkill}). Ranged weapons get +${skillBonus} bonus.${traitDesc}</p>`;
            } else if (meleeSkill > shootingSkill) {
                skillPref = `<p><strong>Skill Preference:</strong> Slight melee preference (Melee ${meleeSkill} vs Shooting ${shootingSkill}). Melee weapons get +${skillBonus} bonus.${traitDesc}</p>`;
            } else {
                skillPref = `<p><strong>Skill Preference:</strong> No preference (both skills at ${shootingSkill}).${traitDesc}</p>`;
            }

            // Filter awareness
            const filter = document.getElementById('weaponFilter').value;
            const filterNote = '';

            document.getElementById('recommendation').innerHTML = `
                <h3>Balance at ${qualityName}</h3>
                ${filterNote}
                ${skillPref}
                <p><strong>Average Ranged Score:</strong> ${avgRangedScore.toFixed(1)}</p>
                <p><strong>Average Melee Score:</strong> ${avgMeleeScore.toFixed(1)}</p>
                <hr>
                <h4>Optimized Scoring System Notes:</h4>
                <ul>
                    <li><strong>Performance optimized:</strong> Weapon base scores are cached to reduce calculations by ~66%</li>
                    <li>Situational weapons (grenades, launchers) are capped at ~80 points to ensure they're only used when needed</li>
                    <li>Ranged multiplier: 10, Melee multiplier: 8 - slightly favors ranged weapons in balanced scoring</li>
                    <li>DPS and burst matter, with simplified burst bonus formula: 10 × log(burst + 1)</li>
                    <li>Combined range scoring: Multiplier and bonus calculated together for efficiency</li>
                    <li>Progressive range penalties ensure short-range weapons (shotguns) don't dominate due to high DPS alone</li>
                    <li>No accuracy calculations (removed for performance) - range modifiers handle engagement distance penalties</li>
                    <li>Power creep protection: DPS > 30 has diminishing returns (50% value for excess)</li>
                    <li>Quality affects both DPS and armor penetration values</li>
                    <li>Armor penetration adds significant value for late-game effectiveness</li>
                    <li>AP estimation removed for melee weapons - uses actual values only</li>
                    <li>Skill scores use gradual exponential growth: Base 30 × 1.15^(levels-1)</li>
                    <li>Pawn traits and work assignments will further modify these scores</li>
                    <li>Brawler trait: -500 penalty for ranged, +200 bonus for melee weapons</li>
                    <li>Hunting work: +100 bonus for all ranged weapons</li>
                    <li>Natural weapons (Thrumbo Horn, etc.) have fixed stats that don't change with quality</li>
                </ul>
                `;
        }
    </script>
</body>
</html>